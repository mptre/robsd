name: test

on:
  - push
  - pull_request

jobs:
  linux-clang-sanitize:
    runs-on: ubuntu-22.04
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: dependenices
        run: sudo apt-get update && sudo apt-get install libxml2-utils
      - name: test
        env:
          CC: clang
          PORTABLE: yes
        run: |
          ./configure --pedantic --sanitize
          make -j`nproc` test

  linux-gcc-fuzz:
    runs-on: ubuntu-22.04
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: dependenices
        run: sudo apt-get update && sudo apt-get install afl
      - name: test
        env:
          CC: afl-gcc
        run: |
          ./configure --pedantic --fuzz afl
          make -j`nproc` fuzz

  linux-gcc-i386:
    runs-on: ubuntu-22.04
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: dependenices
        run: sudo apt-get update && sudo apt-get install gcc-multilib libxml2-utils
      - name: test
        env:
          CC: gcc
          CFLAGS: -m32
          LDFLAGS: -m32
          PORTABLE: yes
        run: |
          ./configure --pedantic
          make -j`nproc` test

  linux-gcc-ndebug:
    runs-on: ubuntu-22.04
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: dependenices
        run: sudo apt-get update && sudo apt-get install libxml2-utils
      - name: test
        env:
          CC: gcc
          CPPFLAGS: -DNDEBUG
          PORTABLE: yes
        run: |
          ./configure --pedantic
          make -j`nproc` test

  linux-gcc-sanitize:
    runs-on: ubuntu-22.04
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: dependenices
        run: sudo apt-get update && sudo apt-get install libxml2-utils
      - name: test
        env:
          CC: gcc
          PORTABLE: yes
        run: |
          ./configure --pedantic --sanitize
          make -j`nproc` test

  linux-gcc-valgrind:
    runs-on: ubuntu-22.04
    steps:
      - name: checkout
        uses: actions/checkout@v2
      - name: dependenices
        run: sudo apt-get update && sudo apt-get install libxml2-utils valgrind
      - name: test
        env:
          CC: gcc
          EXEC: valgrind
          PORTABLE: yes
          TESTFLAGS: -Tmemleak
        run: |
          ./configure --pedantic
          make -j`nproc` test
