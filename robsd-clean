#!/bin/ksh

set -eu

usage() {
	echo "usage: robsd-clean -m mode count" 1>&2
	exit 1
}

. "${EXECDIR:-/usr/local/libexec/robsd}/util.sh"
. "${EXECDIR:-/usr/local/libexec/robsd}/util-ports.sh"
. "${EXECDIR:-/usr/local/libexec/robsd}/util-regress.sh"

setprogname "robsd-clean"
[ "$(id -u)" -ne 0 ] && fatal "must be run as root"

_mode=""

while getopts "m:" opt; do
	case "$opt" in
	m)	_mode="${OPTARG}";;
	*)	usage;;
	esac
done
shift $((OPTIND - 1))
{ [ -n "$_mode" ] && [ $# -eq 1 ]; } || usage

setmode "$_mode"

config_load <<'EOF'
ROBSDDIR="${robsddir}"
KEEPDIR="${keep-dir}"
EOF

purge "$ROBSDDIR" "$1" | while read -r _d; do
	info "moving ${_d} to ${KEEPDIR}"
done
